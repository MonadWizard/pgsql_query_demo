--SIMPLIFY QUERY

-- find the most popular users - The user who were tag most

-- WITH tags AS (
-- 	SELECT user_id FROM photo_tags
-- 	UNION ALL
-- 	SELECT user_id FROM caption_tags
-- )

-- SELECT username, COUNT(*)
-- FROM users
-- JOIN tags
-- ON tags.user_id=users.id
-- GROUP BY username
-- ORDER BY COUNT(*) DESC; 

-- or by creating a view

-- CREATE VIEW view_tags AS(
-- 	SELECT id, created_at, user_id, post_id, 'photo_tag' AS type FROM photo_tags
-- 	UNION ALL
-- 	SELECT id, created_at, user_id, post_id, 'caption_tag' AS type FROM caption_tags
-- );


-- -- SELECT * FROM view_tags
-- WITH tags AS (
-- 	SELECT user_id FROM photo_tags
-- 	UNION ALL
-- 	SELECT user_id FROM caption_tags
-- )

-- SELECT username, COUNT(*)
-- FROM users
-- JOIN view_tags
-- ON view_tags.user_id=users.id
-- GROUP BY username
-- ORDER BY COUNT(*) DESC; 


-- -- find 10 most recent post
-- CREATE VIEW recent_post AS (
-- 	SELECT * 
-- 	FROM posts
-- 	ORDER BY created_at DESC
-- 	LIMIT 10
-- );

-- SELECT * FROM recent_post;



-- -- SHOW user who create 10 most recent posts using view
-- SELECT username
-- FROM recent_post
-- JOIN users ON recent_post.user_id = users.id;


-- -- Show the likes each of the 10 most recent posts received
-- WITH post_likes AS (
-- 	SELECT user_id, post_id FROM likes WHERE post_id IS NOT NULL
-- )
-- SELECT count(*) 
-- FROM recent_post
-- JOIN post_likes 
-- ON recent_post.user_id = post_likes.user_id
-- GROUP BY post_likes.user_id;


-- Show the users who were tags on most recent posts


-- Show the hashtags used by the 10 most recent posts
-- Show the average number of hashtags used in the 10 most recent posts
-- Show the total number of comments 10 most recent posts received



-- -- SHOW how many like and comment on post for par week.  (take more time so, we can use materialized view)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 =
-- SELECT 
-- 	date_trunc('week', COALESCE(posts.created_at, comments.created_at)) AS week,
-- 	COUNT (posts.id) AS num_likes_for_posts,
-- 	COUNT (comments.id) AS num_likes_for_comments
-- FROM likes
-- LEFT JOIN posts ON posts.id=likes.post_id
-- LEFT JOIN comments ON comments.id=likes.comment_id
-- GROUP BY week
-- ORDER BY week;


-- make materialize
CREATE MATERIALIZED VIEW weekly_likes AS (
	SELECT 
		date_trunc('week', COALESCE(posts.created_at, comments.created_at)) AS week,
		COUNT (posts.id) AS num_likes_for_posts,
		COUNT (comments.id) AS num_likes_for_comments
	FROM likes
	LEFT JOIN posts ON posts.id=likes.post_id
	LEFT JOIN comments ON comments.id=likes.comment_id
	GROUP BY week
	ORDER BY week
) WITH DATA;

-- now take much minimal time then regular, cause this custom table is materilized view
SELECT * FROM weekly_likes

-- if we update any data on any table which are join and create weekly_likes,then It can't be update automatically. Like

DELETE FROM posts
WHERE created_at < '2010-02-01';

SELECT * FROM weekly_likes  -- deleted data are still here, so we need to refresh materilized view

-- REFRESH MATERIALIZED VIEW
REFRESH MATERIALIZED VIEW weekly_likes

-- now update are taken on materialized view
SELECT * FROM weekly_likes






